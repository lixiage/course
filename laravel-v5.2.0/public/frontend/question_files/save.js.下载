define(function(require){function a(a){return a.replace(/[^\x00-\xff]/g,"__").length}function c(){var c,v=$(this);return a(c=$.trim(v.val()))<10?(v.addClass("ipt-error"),g.error.call(this,"标题不能少于5个汉字！"),!1):a(c)>100?(v.addClass("ipt-error"),g.error.call(this,"标题不能大于50个汉字！"),!1):(v.removeClass("ipt-error"),void g.error.call(this,""))}require("/static/page/course/common/autocomplete.js");var v=require("../common/verify-code.js"),h=require("store"),g={error:function(a,c){arguments.length<2&&(c=a,a=$(this).next(".errortip")),c?$(a).html(c):$(a).empty()}},C=$("#ques-title");window.UEDITOR_HOME_URL="/static/lib/ueditor/";var w=UE.getEditor("ques-editor",{imagePopup:!0,initialFrameHeight:280});w.on("ready",function(){var a=this;setTimeout(function(){a.execCommand("drafts"),C.focus()})}),w.addListener("focus",function(){$("#ques-editor .edui-editor-iframeholder").removeClass("tag")}),w.addListener("blur",function(){""==w.getContent()&&$("#ques-editor .edui-editor-iframeholder").addClass("tag")}),v.renderVerifyCodeBlock(".verify-code","/wenda/getsavecode"),void 0===C[0].placeholder&&C.focus(function(){var a=$(this);a.val()===a.attr("placeholder")&&a.val("").removeClass("placeholder")}).blur(function(){var a=$(this);a.val().length||a.val(a.attr("placeholder")).addClass("placeholder")});var y=h.get("titleVal");C.val("No"==y?"":y),C.on("blur",function(){h.set("titleVal",C.val())});!function(){var a=$(".js-global-error");return{hide:function(){a.hide()},show:function(t){a.text(t).show()}}}();C.blur(c);var b=($("#tagcontent"),$(".pop-tips-layer")),j=function(){var a=-(parseInt(b.width())+2)/2+"px",c=-(parseInt(b.height())+2)/2+"px";b.css({marginLeft:a,marginTop:c}),setTimeout(function(){b.hide()},2e3)},k=function(){var a,w,y,k=$("#ques-submit-btn"),E=$("#no-credit"),T=$("#enough-credit"),_=$("#interal-use");if(!k.hasClass("ques-loading")&&(y={},c.call(C)!==!1)){if(a=UE.getEditor("ques-editor"),w=a.getContent(),w.length>2e4)return void g.error("#editor-wrap .errortip","超过字数上限，最多输入20000字");if(0==$("#js-tags .onactive").length)return void g.error("#js-tags ~ .errortip","问题至少选择1个分类");if(g.error("#js-tags ~ .errortip",""),$(".interal-checked").length)y.checkcount=1,y.verify=1;else if(0!==k.parent().prev(".verify-box").find(".js-verify-refresh").length){var V=$.trim(v.getResult(".verify-code"));if(0==V.length)return void $(".verify-code").trigger("fail","请输入验证码");y.verify=V}var L=[];$("#js-tags .onactive").each(function(a,c){L.push($(c).attr("data-id"))}),y.title=C.val(),y.content=w,y.label_ids=L.join(","),k.addClass("ques-loading").text("发布中...");var O=window.location.href;-1!=O.indexOf("?")&&(y.topic_id=O.slice(O.indexOf("?")+1)),$(".verify-code").trigger("succ"),$.ajax({url:"/wenda/saveques",type:"post",dataType:"json",data:y,success:function(c){return 0===c.result?(_.removeClass("interal-checked"),a.execCommand("clearlocaldata"),h.set("titleVal",""),void(window.location.href="/wenda/savesuccess/id/"+c.data.id)):1e3==c.result?void $.alert("发布成功，审核通过后才能显示",{callback:function(){window.location.href="/wenda"}}):void(-103002==c.result?($(".verify-code").trigger("fail",""),$.prompt("验证码错误，请重试",{icon:"error"}),j(),setTimeout(function(){v.renderVerifyCodeBlock(".verify-code","/wenda/getsavecode")},1e3)):-105001==c.result?(E.show(),E.find(".cancel-cf").on("click",function(){E.hide()})):105002==c.result?(T.show(),$("#interal-cancel").on("click",function(){T.hide()}),_.on("click",function(){$(this).addClass("interal-checked"),T.hide(),$("#ques-submit-btn").trigger("click")})):-5==c.result?$.prompt("问题或补充中有违禁词，请修改后重试",{icon:"error"}):$.prompt(c.msg||"发布失败",{icon:"error",timeout:5e3}))},error:function(){$(b).html('<i class="icon-point"></i> 服务器错误，请稍后重试！').show(),j()},complete:function(){k.removeClass("ques-loading").text("发布(Ctrl+Enter)")}})}};$("#ques-submit-btn").click(k),$(document).on("submit.imooc",function(){k()}),$(".js-ques-category a").click(function(e){e.preventDefault();var a;(a=$(this)).hasClass(".onactive")||a.siblings(".onactive").removeClass("onactive").end().addClass("onactive")}),$("#js-tags").on("click",".save-list-tag",function(){{var a=$(this);a.attr("data-id")}if(a.hasClass("onactive"))a.removeClass("onactive");else{if($("#js-tags .onactive").length>2)return;a.addClass("onactive")}}),$("#tagcontent").on("click",".list-tag",function(){var a=$(this),c=a.attr("data-id");a.remove(),$('#js-tags [data-id="'+c+'"]').removeClass("onactive"),0===$("#tagcontent .list-tag").length&&$("#label-default").show()})});