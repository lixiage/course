define(function(require){function a(){var a=[];return $("#js-tags .onactive").each(function(c,v){a.push($(v).attr("tag-id"))}),a.join(",")}function c(a){for(var c=$("#js-tags .for-choice"),v=0,w=a.length;w>v;v++)for(var i=0,l=c.length;l>i;i++)c.eq(i).attr("tag-id")==a[v]&&c.eq(i).addClass("onactive")}function v(a){var c,v,w=['<div id="js-wmd-wrap-{id}" class="wmd-wrap">','<div id="wmd-button-bar-{id}" class="wmd-button-bar-{id} wmd-button-bar">','<ul id="wmd-button-bar-right-{id}" class="l wmd-button-bar-right">','<li class="wmd-button wmd-button-fullscreen" title="全屏"><span></span></li>',"</ul>",'<div class="wmd-line"></div>','<p class="r preview-title">预览</p>',"</div>",'<div id="js-wmd-input-wrap-{id}" class="wmd-input-wrap"><textarea id="wmd-input-{id}"></textarea></div>','<div id="js-wmd-preview-wrap-{id}" class="wmd-preview-wrap">','<div id="wmd-preview-{id}" class="wmd-preview"></div>',"</div>","</div>"].join("").replace(/\{id\}/g,a);v=$("#"+a).find("textarea").val(),$("#"+a).html(w),$("#"+a).find("textarea").val(v),$("#"+a).on("mouseenter",".wmd-button-bar-right .wmd-button",function(){$(this).hasClass("wmd-button-disabled")||$(this).addClass("wmd-button-hover")}).on("mouseleave",".wmd-button-bar-right .wmd-button",function(){$(this).removeClass("wmd-button-hover")}).on("click",".wmd-button-preview",function(){c.preview()}).on("click",".wmd-button-edit",function(){c.edit()}).on("click",".wmd-button-fullscreen",function(){var v=$(this);c.edit(1),v.hasClass("wmd-button-smallscreen")?($("#js-wmd-wrap-"+a).removeClass("wmd-wrap-model-full"),$("#wmd-input-js-mk").removeClass("wmd-decorate"),v.removeClass("wmd-button-smallscreen"),$("body").css({overflow:"auto"})):($("#js-wmd-wrap-"+a).addClass("wmd-wrap-model-full"),$("#wmd-input-js-mk").addClass("wmd-decorate"),v.addClass("wmd-button-smallscreen"),$("body").css({overflow:"hidden"}),c.disable("preview"))}),c=function(){var v=$("#js-wmd-wrap-"+a),w=$("#wmd-button-bar-right-"+a),g="wmd-button-disabled";return{enable:function(a){c.getEl(a).removeClass(g)},disable:function(a){c.getEl(a).addClass(g)},isDisabled:function(a){return c.getEl(a).hasClass(g)},getEl:function(a){var c;return c="string"==typeof a?w.find(".wmd-button-"+a):$(a)},preview:function(){c.isDisabled("preview")||(c.disable("preview"),c.enable("edit"),$("#wmd-button-row-"+a).hide(),v.addClass("wmd-wrap-model-preview"))},edit:function(w){(w||!c.isDisabled("edit"))&&(c.enable("preview"),c.disable("edit"),$("#wmd-button-row-"+a).show(),v.removeClass("wmd-wrap-model-preview"))}}}();var g=Markdown.getSanitizingConverter();Markdown.Extra.init(g,{extensions:"all",highlighter:"prettify"});var b=new Markdown.Editor(g,"-"+a);b.hooks.set("insertImageDialog",function(){function a(){function g(a){$("#js-amu-msg").text(a)}$(this);w=WebUploader.create({swf:"//static.mukewang.com/static/lib/webupload/Uploader.swf",server:"/article/ajaxuploadimg",pick:{id:"#js-amu-btn",multiple:!1},resize:!1,fileVal:"photo",fileNumLimit:1,fileSize:5242880,accept:{extensions:"jpg,jpeg,gif,png,bmp"}}),w.on("beforeFileQueued",function(a){for(var c=w.getFiles(),v=c.length;v--;)w.removeFile(c[v],!0);$("#js-amu-ipt").val(a.name)}),w.on("fileQueued",function(){g("")}),w.on("error",function(a){var m={Q_EXCEED_NUM_LIMIT:"一次只能上传一张图片",Q_EXCEED_SIZE_LIMIT:"图片不能超过5M",Q_TYPE_DENIED:"图片类型不支持"};g(m[a]||"文件格式不支持！")}),w.on("uploadAccept",function(a,c){$("#upload-progress").remove(),0!==c.result?g(c.msg||"上传错误，稍后重试~"):(v&&v(c.data.imgpath),$("#js-modal-mk-image").modal("hide"))}),w.on("uploadStart",function(){g("正在上传...")}),w.on("uploadError",function(){g("上传错误，请稍后重试")}),w.on("uploadComplete",function(){c()}),a=$.noop}function c(a){w.stop(),w.reset(),$("#js-amu-ipt").val("请选择不大于5M的图片"),a&&$("#js-amu-msg").text("")}var v=null;$("#js-amu-upload-btn").on("click",function(){w.upload()}),$("#js-modal-mk-image").on("shown.bs.modal",function(){a()}).on("hide.bs.modal",function(){c(1)});var w;return function(a){return $("#js-modal-mk-image").modal("show"),v=a,1}}()),b.hooks.addNoop("insertLinkDialog"),b.hooks.set("insertLinkDialog",function(){var a;return $("#js-modal-mk-link").on("shown.bs.modal",function(){var a=$("#js-aml-ipt");a.val(a.attr("placeholder")),setTimeout(function(){a.focus().select()},1)}),$("#js-aml-btn").click(function(){var c="http://",v=$("#js-aml-ipt");v.val()!==v.attr("placeholder")&&(c=v.val()),a(c),$("#js-modal-mk-link").modal("hide")}),function(c){return a=c,$("#js-modal-mk-link").modal("show"),1}}()),b.hooks.chain("onPreviewRefresh",prettyPrint),b.run()}function w(){_.setItem("already","1"),$("#js-mask").hide(),$("#js-editTip").hide()}require("util/modal.button.js"),require("lib/webupload/webuploader.withoutimage.min.js"),require("lib/webupload/webuploader.css"),require("lib/pagedown/Markdown.Editor.js"),require("lib/pagedown/editor.css"),require("lib/pretty/prettify.js"),require("lib/pretty/prettify.css");var g=require("store");if($("#js-tags").on("click",".for-choice",function(){{var a=$(this);a.attr("tag-id")}if(a.hasClass("onactive"))a.removeClass("onactive");else{if($("#js-tags .onactive").length>2)return;a.addClass("onactive")}}),$("#js-tags").data("oldlabel")){var b=$("#js-tags").data("oldlabel"),h=b.toString().split(",");c(h)}v("js-mk"),!function(){function a(a){$("#js-face-reault").text(a)}var c;c=WebUploader.create({swf:"/static/lib/webupload/Uploader.swf",server:"/article/ajaxuploadimg",pick:{id:"#js-face-upload",multiple:!1},resize:!1,fileVal:"photo",fileNumLimit:1,fileSize:2097152,auto:!0,sendAsBinary:!1,accept:{extensions:"jpg,jpeg,gif,png,bmp"}}),c.on("beforeFileQueued",function(){for(var a=c.getFiles(),v=a.length;v--;)c.removeFile(a[v],!0)}),c.on("fileQueued",function(){a("")}),c.on("error",function(c){var m={Q_EXCEED_NUM_LIMIT:"一次只能上传一张图片",Q_EXCEED_SIZE_LIMIT:"图片不能超过2M",Q_TYPE_DENIED:"图片类型不支持"};a(m[c]||"文件格式不支持！")}),c.on("uploadAccept",function(c,v){$("#upload-progress").remove(),0!==v.result?a(v.msg||"上传错误，稍后重试~"):($("#js-face-reault").html('<div class="face-result-inner"><img src="'+v.data.imgpath+'" width="120"><span class="rm-face-reault">删除</span></div>'),$("#art-face").val(v.data.key))}),c.on("uploadStart",function(){a("正在上传...")}),c.on("uploadError",function(){a("上传错误，请稍后重试")}),c.on("uploadComplete",function(){c.reset()}),$("#js-face-reault").on("click",".rm-face-reault",function(){$("#js-face-reault").empty(),$("#art-face").val(""),c.reset()})}();var j=function(a){if(!a)return 0;var c=a.match(/[^\x00-\xff]/g);return a.length+(c?c.length:0)},k={title:function(a){var c,v=$("#art-title");if(a||v.attr("data-valided")){v.attr("data-valided",1),c=$.trim(v.val());var w=j(c);return w>70?(k.msg(v,"标题不能超过35个汉字！"),!1):20>w?(k.msg(v,"标题不能少于10个汉字！"),!1):(k.msg(v),c)}},msg:function(a,c){var v=$(a);v[c?"addClass":"removeClass"]("ipt-error"),v.siblings(".form-ipt-error").html(c||"")}};$(".ori-tip,.original").on("click",function(){if(!$(this).hasClass("disabled")){var a=$(".original"),c=$("#is-ori");a.hasClass("sns-checkbox-o")?(a.removeClass("sns-checkbox-o").addClass("sns-checkbox"),c.prop("checked",!0)):(a.removeClass("sns-checkbox").addClass("sns-checkbox-o"),c.prop("checked",!1))}});var C=function(a,c){var v="";0==a&&(v=" pop-error");var w='<div class="contain-coverLayer"></div>',g='<div id="js-pop-del" class="pop-deleting"><div class="deleting-bd'+v+'"></div><div class="deleting-btm">'+c+"</div></div>";$("body").append(g).append(w),setTimeout(function(){$("#js-pop-del").remove(),$(".contain-coverLayer").remove()},1500)},E=function(){var c,v=$("#js-submit"),w=$("#js-tags");if(!v.hasClass("loading")){if(c={},old_label&&(c.old_label_ids=old_label),0==w.find(".onactive").length)return void w.siblings(".form-ipt-error").text("手记至少选择1个分类");if(w.siblings(".form-ipt-error").text(""),c.label_ids=a(),c.title=k.title(1),c.title){if(c.is_original=$("#check-status").hasClass("sns-checkbox")?1:0,2==$("#check-status").data("check")&&(c.is_original=2),c.pic=$("#art-face").val(),c.content=$("#js-mk textarea").val(),c.content.length<200)return void $("#js-mk").siblings(".form-ipt-error").text("内容不能少于200个字！");$("#js-mk").siblings(".form-ipt-error").text("");var b="/article/ajaxpublish";OP_CONFIG.preid&&(b="/article/ajaxedit",c.id=OP_CONFIG.preid),v.addClass("loading").text("正在提交..."),$.ajax({url:b,type:"post",data:c,dataType:"json",success:function(a){function c(v){window.setTimeout(function(){v--,v>0?(g.set("title",""),g.set("content",""),g.set("tags",""),c(v)):window.location.replace("/article/"+a.data)},800)}if(0===a.result)$(".js-submit-tip").length>0?C(1,"成功提交审核"):C(1,"手记发布成功"),c(3);else{if(-1011==a.result)return void $("#js-mk").siblings(".form-ipt-error").text("当前内容过长，已超过手记最多20000字限制，建议备份后分成多篇发表");C(0,a.msg)}},error:function(){C(0,"发布失败")},complete:function(){v.removeClass("loading").text("提交(Ctrl+Enter)")}})}}};$("#art-title").on({blur:function(){k.title(1)},keyup:function(){k.title()}}),$("#art-cat").change(function(){k.cat()}),$("#js-submit").click(E),/edit/.test(window.location.href)||!function(){function v(){$(".form-ipt-wrap.edit-area .tip").fadeIn(200,function(){b=window.setTimeout(function(){$(".form-ipt-wrap.edit-area .tip").hide()},3e3)})}function w(){window.setTimeout(function(){var b=$.trim($("#art-title").val()),h=$.trim($("#js-mk textarea").val()),j=a(),k=j.toString().split(","),C=g.get("tags");if(C)var E=C.toString().split(",");b==g.get("title")&&h==g.get("content")&&j==g.get("tags")||(g.set("title",b),g.set("content",h),"edit"==OP_CONFIG.page?j?(g.set("tags",j),c(k)):(g.set("tags",C),C&&c(E)):(g.set("tags",j),c(k)),v()),w()},12e3)}var b=null;if($("#art-title").val(g.get("title")),$("#js-mk textarea").val(g.get("content")),g.get("tags")){var h=g.get("tags").toString().split(",");c(h)}$(".form-ipt-wrap.edit-area .tip i").on("click",function(){$(".form-ipt-wrap.edit-area .tip").hide(0),window.clearTimeout(b)}),w()}(),$(document).on("submit.imooc",function(){E()});var _=window.localStorage;_.getItem("already")?($("#js-mask").hide(),$("#js-editTip").hide()):($("#js-mask").show(),$("#js-editTip").show()),$("#js-editTip").on("click",".close",function(){w()}),$("#js-editTip").on("click",".save",function(){w()})});