define(function(require){require("../../base/placeholder/placeholder.js"),require("../../base/util/modal.button.js"),require("../../base/util/core.js"),require("../../base/autocomplete/autocomplete.js"),require("../../base/qrcode/qrcode.min.js"),require("/static/lib/fingerprintjs2/fingerprintjs2.min.js"),require("./tpl/signup.js"),require("./tpl/signin.js"),require("./tpl/erweima.js"),require("./tpl/phoneVerity.js"),require("./tpl/registerFinished.js"),require("./tpl/email_RegisterFinished.js"),require("./tpl/emailVerity.js"),require("./tpl/phoneValidate.js"),require("/static/lib/backbone/backbone-1.0.0.min.js");var a=require("../../base/util/cookie.js");Loginview=Backbone.View.extend({initialize:function(a){this.verifyFinished=!1,this.options=a,this.dom=a&&"signup"==a.mode?signupTpl:signinTpl,this.interval=null,this.val=null,this.loginWithCode=!1,this.verifyLoad=!1,this.IfPWDTypeChange=!0;var c=this;moco.validateCallback.checkusername=function(a){c.blurToCheckUserName(a)},moco.validateCallback.checkverity=function(a){c.checkverity(a)},OP_CONFIG&&(new Fingerprint2).get(function(a){OP_CONFIG.browser_key=a})},events:{"mousedown #signup-btn":"clickToSignup","click .js-verify-refresh":"clickToRefreshVerifyCode","click .xa-showSignup":"clickToShowSignup","click .xa-showSignin":"clickToShowSignin","mousedown .js-proclaim":"clickToProclaimCode","click .xa-showQrcode":"clickToShowQrcode","click .xa-hideQrcode":"clickToHideQrcode","click .xa-refresh":"clickToShowQrcode","keyup .xa-emailOrPhone":"keyupCheckEmailOrPhone","focus .xa-emailOrPhone":"focusautocomplete","focus input":"focusToHideError","blur .xa-emailOrPhone":"blurToTrim","click .js-reSend":"clickToresendPhoneCode","click .js-back":"clickToBack","click [data-login-sns]":"clickShowotherLogin","click .xa-endRegister":"clickToFinishedRegiter","mousedown .xa-submitePhoneVerity":"clickTosubmitePhoneVerity","click .xa-login":"clickToLogin","keyup .js-loginPassword":"keyupJudgeIfShwoVerity","keyup .js-loginWrap input":"keyupToTriggerLogin","keyup .js-registerWrap input":"keyupToTriggerRegister","keyup .js-phoneVerityWrap input":"keyupToTriggerSubmitePhoneVerity","click #js-gotoVerity":"clickToVerityEmail","click  .js-gotoSetting":"clickTolink","click  .js-gotoLearn":"clickTolearn","keydown .ipt-verify":"focusIfCanVertify","click #signup-protocol":"clickProtocol"},focusIfCanVertify:function(){this.verifyFinished=!1},keyupToTriggerLogin:function(e){"13"==e.keyCode&&this.$el.find(".xa-login").trigger("click")},keyupToTriggerRegister:function(e){"13"==e.keyCode&&this.$el.find("#signup-btn").trigger("mousedown")},keyupToTriggerSubmitePhoneVerity:function(e){"13"==e.keyCode&&this.$el.find(".xa-submitePhoneVerity").trigger("mousedown")},keyupJudgeIfShwoVerity:function(){if(this.loginWithCode)this.showLoginVerify();else if(!this.verifyLoad){this.verifyLoad=!0;var a=this;$.get(imoocSSO.checkVerifyUrl,"username="+$('[name="email"].ipt').val(),function(c){10001==c.status&&a.showLoginVerify()},"json")}},showLoginVerify:function(){"none"==this.$el.find(".js-verify-row").css("display")&&(this.$el.find(".js-verify-row").show(),this.$el.find(".verify-img-wrap").append($('<img class="verify-img"/>'))),this.refreshVerifyCode()},focusToHideError:function(){$(".rlf-tip-globle").text("")},blurToTrim:function(a){$(a.currentTarget).val($.trim($(a.currentTarget).val()))},focusautocomplete:function(a){$(a.currentTarget).autocomplete()},clickProtocol:function(){$("#signup-protocol")[0].checked?$("#signup-protocol").parents(".rlf-group").find(".rlf-tip-wrap").removeClass("rlf-tip-error").html(""):$("#signup-protocol").parents(".rlf-group").find(".rlf-tip-wrap").addClass("rlf-tip-error").html("请同意慕课网注册协议")},clickToSignin:function(){},clickShowotherLogin:function(a){this.winsns.open($(a.currentTarget).attr("data-login-sns"))},keyupCheckEmailOrPhone:function(a){var c=$(a.currentTarget);-1!=c.val().indexOf("@")?(c.attr("data-validate","require-email"),this.$el.find(".xa-passwordWrap").show()):(c.attr("data-validate","require-mobile-phone"),this.$el.find(".xa-passwordWrap").hide())},math:function(){var a="sohu.com::http://mail.sohu.com                         |sina.com,sina.cn :: http://mail.sina.com                         |vip.sina.com :: http://vip.sina.com.cn                         |126.com :: http://www.126.com                         |163.com :: http://mail.163.com                         |vip.163.com :: http://vip.163.com                         |vip.126.com :: http://vip.126.com                         |qq.com,vip.qq.com :: http://mail.qq.com                         |msn.com,outlook.com,hotmail.com,live.cn,live.com :: http://outlook.com                         |gmail.com :: http://www.gmail.com                         |yahoo.com.cn,yahoo.cn,aliyun.com :: http://mail.aliyun.com                         |yahoo.com.tw :: http://mail.yahoo.com.tw                         |21cn.com :: http://mail.21cn.com                         |tom.com :: http://mail.tom.com/ ",c={};$.each(a.split("|"),function(a,h){var i,g,v=h.split("::"),h=$.trim(v[1]);for(v=v[0].split(","),i=0,g=v.length;g>i;i++)c[$.trim(v[i])]=h});var h=c[this.val.username.match(/[^@]*$/)[0]];return h},clickToVerityEmail:function(){var a=this.math();window.open(a)},clickTolink:function(){window.location.href="//www.imooc.com/user/setprofile"},blurToCheckUserName:function(a){var c=a;moco.validateCallback.rel=!1;var h="/passport/user/checkphone",g={phone:c};-1!=c.indexOf("@")&&(h=imoocSSO.checkUserName,g={username:c}),$.ajax({url:h,method:"get",async:!1,data:g,dataType:"json",success:function(a){10001==a.status?(moco.validateCallback.errorHint="",moco.validateCallback.rel=!0):(moco.validateCallback.errorHint=a.msg,moco.validateCallback.rel=!1)},error:function(){moco.validateCallback.errorHint="网络错误"}})},checkverity:function(a){if(moco.validateCallback.rel=!1,this.verifyFinished)return void(""!=moco.validateCallback.errorHint?moco.validateCallback.errorHint="网络错误":moco.validateCallback.rel=!0);var c=this,c=this;$.ajax({url:imoocSSO.checkVerifyCode,method:"get",async:!1,data:{verify:a},dataType:"json",success:function(a){this.emailRetisterFinish||(10001==a.status?(moco.validateCallback.errorHint="",moco.validateCallback.rel=!0):moco.validateCallback.errorHint=a.msg)},error:function(){moco.validateCallback.errorHint="网络错误"},complete:function(){c.verifyFinished=!0}})},clickToSignup:function(a){if(W.validate(this.$el.find(".xa-emailOrPhone").parent())&&W.validate(this.$el.find(".ipt-verify ").parent())&&W.validate(this.$el.find(".js-pass-pwd").parent())){if(!$("#signup-protocol")[0].checked)return void $("#signup-protocol").parents(".rlf-group").find(".rlf-tip-wrap").addClass("rlf-tip-error").html("请同意慕课网注册协议");$(a.currentTarget).text("正在注册..."),$(a.currentTarget).attr("disabled","disabled");var c={username:this.$el.find("[name='email'].ipt").val(),password:this.$el.find("[name='password'].ipt").val(),verify:this.$el.find(".ipt-verify").val()};this.val=c,-1!=c.username.indexOf("@")?this.emailRegister(c):this.phoneRegister(c)}},clickToShowSignup:function(){clearInterval(this.interval),this.dom=signupTpl,this.render()},clickToShowSignin:function(){clearInterval(this.interval),this.dom=signinTpl,this.render()},clickToShowQrcode:function(){clearInterval(this.interval),this.dom=erweimaTpl,this.render();var a=(new GUID).newGUID(),c="http://www.imooc.com?ma="+a;$("#qrcode").qrcode({width:150,height:150,text:c}),this.loopScan(a)},clickToHideQrcode:function(){clearInterval(this.interval),this.dom=signinTpl,this.render()},clickToProclaimCode:function(a){a.stopPropagation(),this.proclaimCode()},clickToRefreshVerifyCode:function(){this.refreshVerifyCode()},clickTosubmitePhoneVerity:function(){if(W.validate(this.$el.find("#js-phoneVerity").parent())&&W.validate(this.$el.find(".js-pass-pwd ").parent())){$(".xa-submitePhoneVerity").text("正在提交..."),$(".xa-submitePhoneVerity").attr("disabled","disabled");var a=this,c=$.getUrlParam("plantform"),h={number:$(".js-phoneNumber").html(),mobileverify:$("#js-phoneVerity").val(),password:$("#js-password").val(),type:1,referer:window.location.protocol+"//"+window.location.hostname,plantform:c},g={username:$(".js-phoneNumber").html()};$.ajax({url:"/passport/user/phoneregister",data:h,method:"post",dataType:"json",success:function(c){10001==c.status?(imoocSSO.crossDomainAction(function(){a.showRegisterFinished(g)}),imoocSSO.setCrossDomainCookie(c.data.url)):$("#signin-globle-error").addClass("rlf-tip-error").html(c.msg)},error:function(){$("#signup-globle-error").addClass("rlf-tip-error").html("服务错误，稍后重试")},complete:function(){$(".xa-submitePhoneVerity").text("提交").removeAttr("disabled").removeClass("disabled")}})}},clickToFinishedRegiter:function(){window.location.href="//www.imooc.com/user/setprofile"},showPhoneVerity:function(a){this.dom=phoneVerityTpl,this.render(),$(".js-phoneNumber").html(a.username);var c=60;clearInterval(this.interval),this.interval=setInterval(function(){$(".js-second").parent().removeClass("js-reSend"),$(".js-second").parent().removeClass("active"),$(".js-second").html(c),1>c&&($(".js-second").parent().addClass("active"),$(".js-second").parent().addClass("js-reSend"),$(".js-second").html(""),clearInterval(this.interval)),c--},1e3)},clickToBack:function(){this.clickToShowSignup()},clickTolearn:function(){var c=a.get("urlcookie")||"/";(-1!=c.indexOf("checkemail")||-1!=c.indexOf("phonevalidate")||-1!=c.indexOf("newlogin")||-1!=c.indexOf("newsignup"))&&(c="/"),window.location.href=c},clickToShowSignin:function(){this.dom=signinTpl,this.render()},showEmailRegisterFinished:function(a){this.dom=email_RegisterFinishedTpl,this.render(),$(".js-account").html(a.username),$(".js-account").width()>164&&$(".js-account").wrapInner("<div class='breakall'></div>")},showRegisterFinished:function(){this.dom=registerFinishedTpl,this.render()},clickToresendPhoneCode:function(){clearInterval(this.interval),this.phoneRegister(this.val)},phoneRegister:function(a){$("#signup-btn").attr("disabled","disabled"),$(".reSend").attr("disabled","disabled");var c=this,h={number:a.username,verify:a.verify};$.ajax({url:"/passport/user/phoneregister",data:h,method:"post",dataType:"json",success:function(h){10001==h.status?c.showPhoneVerity(a):($("#signup-btn").text("注册").removeAttr("disabled").removeClass("disabled"),$("#signup-globle-error").addClass("rlf-tip-error").html(h.msg),11001==h.status&&($(".rlf-tip-globle").text(h.msg),$(".js-reSend").css("color","#B4B8BB"),$(".js-reSend").css("cursor","default"),$(".js-reSend").removeClass("active"),$(".js-reSend").removeClass("js-reSend"),$(".js-second").html("")))},error:function(){$("#signup-btn").text("注册").removeAttr("disabled").removeClass("disabled"),$("#signup-globle-error").addClass("rlf-tip-error").html("服务错误，稍后重试")},complete:function(){$("#signup-btn").text("注册").removeAttr("disabled").removeClass("disabled"),$(".reSend").removeAttr("disabled")}})},emailRegister:function(c){var h=this,g=$.getUrlParam("plantform");"ipad"==g&&(c.plantform=g),imoocSSO.register({data:c,success:function(g){if(10001==g.status){h.emailRetisterFinish=!0;var v=g.data.userInfo.uid,w={};w.account=c.username,w.uid=v.toString(),w.plantform=$.getUrlParam("plantform"),"ipad"==w.plantform&&window.webkit.messageHandlers.registerSuccess.postMessage(JSON.stringify(w));h.showEmailRegisterFinished(c)}else 10024==g.status&&(a.set("urlcookie",document.URL,{expires:1,domain:"imooc.com",path:"/"}),h.showEmailRegisterFinished(c));$("#signup-globle-error").addClass("rlf-tip-error").html(g.msg)},error:function(){$("#signup-globle-error").addClass("rlf-tip-error").html("服务错误，稍后重试")},complete:function(){$("#signup-btn").text("注册").removeAttr("disabled").removeClass("disabled")}})},loopScan:function(a){function c(){($(document).find(".js-pageLogin").length||$(document).find(".modal-backdrop").length)&&(g>=30?(clearInterval(h.interval),$(".qrcode-bk-validate").removeClass("hide"),$(".qrcode-bk-scand").addClass("hide")):$.ajax({url:"/user/ScanCode",method:"post",data:{codeid:v},dataType:"json",success:function(a){var c=a.data[0].status;3!=c&&(0==c?($(".qrcode-bk-scand").removeClass("hide"),$(".qrcode-bk-validate").addClass("hide")):(1==c&&(clearInterval(h.interval),h.getToken({keyid:a.data[0].keyid,uid:a.data[0].uid,codeid:v})),2==c&&($(".qrcode-bk-scand").addClass("hide"),$(".qrcode-bk-validate").addClass("hide"))))},error:function(){}}),g++)}var h=this,g=0,v=a;clearInterval(this.interval),this.interval=setInterval(c,2e3)},clickToLogin:function(c){if($(".xa-emailOrPhone").keyup(),W.validate(this.$el.find(".xa-emailOrPhone").parent())&&W.validate(this.$el.find(".js-pass-pwd ").parent())&&W.validate(this.$el.find(".ipt-verify ").parent())){var h={username:this.$el.find("[name='email'].ipt").val(),password:this.$el.find("[name='password'].ipt").val(),verify:this.$el.find(".ipt-verify").val()};this.val=h;var g=this;$(".xa-login").val("正在登录..."),$(".xa-login").attr("disabled","disabled");var v=$(c.currentTarget),w=$("#signup-form");if(!v.hasClass("disabled")){var k=$("#auto-signin")[0].checked?"1":"0",y={username:h.username,password:h.password,verify:h.verify,remember:k,pwencode:1,browser_key:OP_CONFIG.browser_key};imoocSSO.login({data:y,success:function(c){if(c.data={userInfo:""},10001==c.status)return void g.fireLogined(c.data.userInfo);if(900001==c.status)return void(window.location.href="//www.imooc.com/user/userfrozen");if(10005==c.status||10007==c.status||90003==c.status)g.showLoginVerify();else if(10024==c.status)return a.set("urlcookie",document.URL,{expires:1,domain:"imooc.com",path:"/"}),void(window.location.href="//www.imooc.com/user/checkemail");$("#signin-globle-error").addClass("rlf-tip-error").html(c.msg),g.loginWithCode&&(g.refreshVerifyCode(),w.find(".ipt-verify").val(""))},error:function(){$("#signin-globle-error").addClass("rlf-tip-error").html("服务错误，稍后重试")},complete:function(){$(".xa-login").val("登录").removeAttr("disabled").removeClass("disabled")}})}}},fireLogined:function(a,c){var e=$.extend($.Event("logined.imooc"),{_data:a});if($("#signin [data-dismiss],#signup [data-dismiss]").trigger("click"),$(document).trigger(e),this.winsns.clear(),!e.isDefaultPrevented()){if(c)return void window.location.replace("/user/setprofile");var h,g=window.location.pathname;return h="error,forget,logout,newforgot,userfrozen,sendresult,resetpasspage,resetpassword,checkaopenguser".split(",").join("|"),h=new RegExp("\\/(?:"+h+")(?:\\/|$|\\?|#)"),h.test(g)?void window.location.replace("/course/list"):OP_CONFIG&&"newlogin"==OP_CONFIG.page&&void 0!=fromURL?void window.location.replace(fromURL):void window.location.reload()}},getToken:function(a){$.ajax({url:"/passport/user/scancode",method:"post",dataType:"json",data:a,success:function(a){if(a.data.caution){$("#signin").hide(),$(".modal-backdrop").hide();var c='<p class="warn-info" style="font-size: 16px;line-height: 28px;max-width: 600px;">'+a.data.caution+"</p>";return c+='<div class="moco-modal-btns">',c+='<a class="moco-btn moco-btn-blue js-modal-close" href="javascript:void(0)">',c+="<span>确定</span>",c+="</a>",c+="</div>",void($.dialog?$.dialog(c,{title:"警告",modal:!0,callback:function(){window.location.href="//www.imooc.com/index/usercheck?uid="+a.data.userInfo.uid}}):(alert(a.data.caution),window.location.href="//www.imooc.com/index/usercheck?uid="+a.data.userInfo.uid))}imoocSSO.crossDomainAction(function(){window.location.reload()}),imoocSSO.setCrossDomainCookie(a.data.url)},error:function(){}})},proclaimCode:function(){if(this.IfPWDTypeChange){"password"==$(".js-pass-pwd").attr("type")?$(".js-pass-pwd").attr("type","text"):$(".js-pass-pwd").attr("type","password"),this.IfPWDTypeChange=!1;var a=this;setTimeout(function(){a.IfPWDTypeChange=!0},200)}},refreshVerifyCode:function(){this.$el.find(".verify-img").attr("src",imoocSSO.verifyCodeUrl+"?t="+(new Date).getTime())},winsns:function(){function a(){for(var a in o)a.indexOf("/user")>-1&&(o[a].close&&o[a].close(),o[a]=null,delete o[a])}var o={};return{open:function(c){var l,t;return o[c]&&o[c].closed===!1?void(o[c].focus&&o[c].focus()):(a(),l=(screen.width-650)/2,t=(screen.height-400)/2,void(o[c]=window.open(c+"&browser_key="+OP_CONFIG.browser_key+"&referer="+window.location.protocol+"//"+window.location.hostname,"_blank","toolbar=no, directories=no, status=no, menubar=no, width=650, height=500, top="+t+", left="+l)).focus())},clear:a}}(),render:function(a){"signin"==a&&(this.dom=signinTpl,clearInterval(this.interval)),"signup"==a&&(this.dom=signupTpl,clearInterval(this.interval)),this.loginWithCode=!1,this.verifyLoad=!1,$(".rl-modal").remove(),$(".modal-backdrop").remove(),this.$el.append(this.dom),this.dom!==signinTpl?(this.$el.find(".verify-img-wrap").append($('<img class="verify-img"/>')),this.refreshVerifyCode()):this.$el.find(".js-verify-row").hide();var m=$(".rl-modal");m.modal("show"),"undefined"!=typeof ownName&&$(".js-own-name").val(ownName);var c=$(".xa-emailOrPhone");c.val()&&(-1!=c.val().indexOf("@")?c.attr("data-validate","require-email"):c.attr("data-validate","require-mobile-phone"))}});{var c=function(){function a(){for(var a in o)a.indexOf("/user")>-1&&(o[a].close&&o[a].close(),o[a]=null,delete o[a])}var o={};return{open:function(c){var l,t;return o[c]&&o[c].closed===!1?void(o[c].focus&&o[c].focus()):(a(),l=(screen.width-650)/2,t=(screen.height-400)/2,void(o[c]=window.open(c+"&referer="+window.location.protocol+"//"+window.location.hostname,"_blank","toolbar=no, directories=no, status=no, menubar=no, width=650, height=500, top="+t+", left="+l)).focus())},clear:a}}();window.__fireLogined=window.__fireLogined||function(a,h){var e=$.extend($.Event("logined.imooc"),{_data:a});if($("#signin [data-dismiss],#signup [data-dismiss]").trigger("click"),$(document).trigger(e),c.clear(),!e.isDefaultPrevented()){if(h)return void window.location.replace("/user/setprofile");var g,v=window.location.pathname;return g="error,forget,logout,newforgot,userfrozen,sendresult,resetpasspage,resetpassword,checkaopenguser,newsignup".split(",").join("|"),g=new RegExp("\\/(?:"+g+")(?:\\/|$|\\?|#)"),g.test(v)?void window.location.replace("/course/list"):void window.location.reload()}}}});